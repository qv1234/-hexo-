{"type":"getPostById","data":{"title":"HICP-BGPIPv6","date":"2023-03-19T11:48:57.120Z","description":"","categories":[{"name":"网络","_id":"clfgd5gdh000y70q4aopo5bql"}],"tags":[{"name":"网络","_id":"clfgd5gdi000z70q485coagt1"}],"content":"<h2 id=\"1-BGP边界网关协议：\"><a href=\"#1-BGP边界网关协议：\" class=\"headerlink\" title=\"1.BGP边界网关协议：\"></a>1.BGP边界网关协议：</h2><h3 id=\"1-概念：\"><a href=\"#1-概念：\" class=\"headerlink\" title=\"1.概念：\"></a>1.概念：</h3><ul>\n<li>BGP不产生路由，负责搬运路由</li>\n<li>使用范围：在AS之间使用的协议</li>\n<li>基于TCP封装，端口号：179</li>\n<li>AS自治系统：取值范围 1-65535，公有AS 1-64511，私有AS 64512-65535</li>\n<li>协议特点：<ul>\n<li>BGP是一种路径矢量型路由协议</li>\n<li>没有算法</li>\n<li>传递网络掩码，支持VLSM（可变长子网掩码）、CIDR（无类别域间路由，超网技术）</li>\n<li>BGP协议中存在大量的属性（是一种基于规则的路由协议）</li>\n<li>BGP协议支持路由认证</li>\n<li>支持BGP路由聚合（汇总）</li>\n<li>BGP是一种非常消耗资源的路由协议</li>\n</ul>\n</li>\n<li>BGP的协议版本：<ul>\n<li>有类别：V1，V2，V3</li>\n<li>无类别：V4（仅仅支持IPv4单播路由传递），V4+（支持IPv4单播路由，IPv6单播，IPv4组播，IPv6组播，VPNV4，VPNV6等）</li>\n<li>默认仅仅支持传递IPV4单播路由，传递其他方式路由时需要开启（激活）</li>\n</ul>\n</li>\n<li>更新地址：单播更新</li>\n<li>更新方式：触发更新，增量更新</li>\n</ul>\n<h3 id=\"2-适合使用BGP的网络环境：\"><a href=\"#2-适合使用BGP的网络环境：\" class=\"headerlink\" title=\"2.适合使用BGP的网络环境：\"></a>2.适合使用BGP的网络环境：</h3><ul>\n<li>传输AS</li>\n<li>多宿主</li>\n<li>需要对进入和离开的流量进行强大的策略控制时</li>\n</ul>\n<h3 id=\"3-BGP邻居关系：\"><a href=\"#3-BGP邻居关系：\" class=\"headerlink\" title=\"3.BGP邻居关系：\"></a>3.BGP邻居关系：</h3><ul>\n<li>IBGP：内部BGP邻居，同一个AS之内的BGP设备的邻居关系</li>\n<li>EBGP：外部BGP邻居，不同AS之间的BGP设备构建的邻居关系</li>\n</ul>\n<h3 id=\"4-BGP消息数据包：\"><a href=\"#4-BGP消息数据包：\" class=\"headerlink\" title=\"4.BGP消息数据包：\"></a>4.BGP消息数据包：</h3><ol>\n<li><p>open报文：建立BGP邻居关系，只发送一次</p>\n<ul>\n<li><p>BGP邻居建立的条件：</p>\n<ol>\n<li>router-id必须不同</li>\n<li>BGP认证一致</li>\n<li>指定正确的AS号</li>\n<li>建立TCP三次握手的两端路由可达</li>\n</ol>\n</li>\n<li><p>图示：</p>\n<img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221125100413407.png\" alt=\"image-20221125100413407\" style=\"zoom: 80%;\" /></li>\n</ul>\n</li>\n<li><p>keepalive报文：保活，维持BGP邻居关系；keepalive 时间（保活）默认为60s，Hold 时间（超时）默认为180s</p>\n<img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221125100614826.png\" alt=\"image-20221125100614826\" style=\"zoom: 80%;\" />\n</li>\n<li><p>update报文：更新</p>\n<ul>\n<li><p>通告路由：</p>\n<ul>\n<li>IBGP路由通告时间为15S</li>\n<li>EBGP路由通告时间为30S</li>\n</ul>\n<img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221125112156267.png\" alt=\"image-20221125112156267\" style=\"zoom:80%;\" />\n</li>\n<li><p>撤销路由：</p>\n<img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221125111814562.png\" alt=\"image-20221125111814562\" style=\"zoom: 80%;\" /></li>\n</ul>\n</li>\n<li><p>notification报文：报告（错误报告）</p>\n<img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221125112451838.png\" alt=\"image-20221125112451838\" style=\"zoom:80%;\" /></li>\n</ol>\n<h3 id=\"5-BGP邻居状态机制：\"><a href=\"#5-BGP邻居状态机制：\" class=\"headerlink\" title=\"5.BGP邻居状态机制：\"></a>5.BGP邻居状态机制：</h3><ul>\n<li>IDLE初始化：检测双方建立邻居的IP地址是否可以通信，然后建立尝试建立TCP连接（TCP报文随机一方先发送）</li>\n<li>Connet连接：建立TCP连接成功后，被动响应一方的状态</li>\n<li>Active活动：建立TCP连接成功后，主动发送一方的状态</li>\n<li>Opensent：主动发送open报文的一方状态；发送open报文，建立BGP的邻居（open报文随机一方先发送）</li>\n<li>Openconfirm：收到open报文的一方状态；报文确认</li>\n<li>Established邻居状态：收到对方的keepalive报文（保活）的一方状态</li>\n</ul>\n<h3 id=\"6-BGP的路由黑洞：\"><a href=\"#6-BGP的路由黑洞：\" class=\"headerlink\" title=\"6.BGP的路由黑洞：\"></a>6.BGP的路由黑洞：</h3><ul>\n<li>在同一个AS中，考虑成本，不会所有设备均运行BGP协议；</li>\n<li>大量的IBGP邻居关系间，为非直连建邻；故必然出现大量单播非直连传递路由信息；最终形成BGP设备路由表可达；而实际<strong>流量在递归到非BGP设备时被丢弃</strong></li>\n<li>即：控制层面显示可达，数据层面在非BGP设备处不可达</li>\n<li>解决方法：<ol>\n<li>在边界设备上将BGP重发布引入IGP协议（仅仅引入EBGP邻居学习幵加表的路由）</li>\n<li>在AS内建立全互联的IBGP邻居关系</li>\n<li>减少IBGP邻居关系的数量，<strong>打破IBGP水平分割</strong><ol>\n<li>路由反射器</li>\n<li>EBGP 联邦</li>\n</ol>\n</li>\n<li>MPLS</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"7-BGP的防环机制：\"><a href=\"#7-BGP的防环机制：\" class=\"headerlink\" title=\"7.BGP的防环机制：\"></a>7.BGP的防环机制：</h3><ul>\n<li><p>IBGP（AS内）：IBGP水平分割机制；next-hop,起源者属性，簇ID列表</p>\n<ul>\n<li><p>IBGP水平分割：</p>\n<ul>\n<li><strong>AS-by-AS规则：一个AS为一个整体，故BGP路由内部传递时，其属性默认没有发生任何变化，故将导致IBGP关系间的环路</strong></li>\n<li>IBGP水平分割机制：<strong>IBGP只传一跳规则，通过一个IBGP邻居学习路由不能传递给其他的IBGP邻居</strong></li>\n<li>IBGP水平分割的打破：路由反射器、EBGP联邦</li>\n</ul>\n</li>\n<li></li>\n</ul>\n</li>\n<li><p>EBGP（AS之间 ）：</p>\n<ul>\n<li>在BGP的路由条目中存在各种属性用于选路，其中有一种<strong>AS-Path属性</strong></li>\n<li>AS-Path用于记录该条目经过的所有AS编号</li>\n<li>EBGP水平分割就是利用AS-Path属性，接收到路由条目中，若出现本地的AS编号记录将拒绝接收该条目</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"8-配置：\"><a href=\"#8-配置：\" class=\"headerlink\" title=\"8.配置：\"></a>8.配置：</h3><h4 id=\"1-BGP建立：\"><a href=\"#1-BGP建立：\" class=\"headerlink\" title=\"1.BGP建立：\"></a>1.BGP建立：</h4><ul>\n<li><p>先保证路由可达</p>\n</li>\n<li><p>启用BGP协议：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bgp [num]     # num为AS自治系统编号\t</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>手工指定router-id</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router-id [本地路由器RID]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>手工指定邻居：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端的直连接口IP地址] as-number [对端的bgp号]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改更新源（环回接口）：默认更新源为到达peer的本地出接口地址</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端的环回接口IP地址] connect-interface [本地的环回接口号]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>注意：IBGP邻居之间禁止双端全部缺省路由</p>\n</li>\n<li><p>修改EBGP之间多跳（EBGP之间数据包TTL默认为1 ），EBGP环回使用环回建立邻居时跳数等于2</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端的环回接口IP地址] ebgp-max-hop [num]    # num值应大于1，默认跳数255</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">作用：1.关闭EBGP之间直连检测 2.修改EBGP数据包的TTL值</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"2-宣告网络：\"><a href=\"#2-宣告网络：\" class=\"headerlink\" title=\"2.宣告网络：\"></a>2.宣告网络：</h4><ul>\n<li><p>本地通过BGP协议学习的路由将自动传递给本地的其他BGP邻居，需要考虑IBGP水平分割；</p>\n</li>\n<li><p>宣告是宣告本地路由表中任何来源的非BGP路由（直连，静态，IBGP等）</p>\n</li>\n<li><p>EBGP邻居宣告网段时，源更新地址不能和宣告环回地址相同（建邻的路由和BGP传递过来的路由是同一个），否则无法生成有效最优路由</p>\n</li>\n<li><p>BGP宣告问题：</p>\n<ul>\n<li>在BGP协议种，本地设备可以宣告本地路由表中所有直连，静态，IGP产生的路由；</li>\n<li>由于在实际工程中，<strong>一个AS内部</strong>存在大量的<strong>未运行BGP协议</strong>的路由器；<strong>它们的用户网段</strong>，需要边界IBGP协议的设备来<strong>代替</strong>它们<strong>宣告</strong>共享到其他的AS</li>\n<li>所以，<strong>边界IBGP设备宣告</strong>本地路由表中<strong>路由条目</strong>时，<strong>默认将携带COST值</strong>；携带COST的路由会被传递给本地设备的EBGP邻居 &#x2F; IBGP邻居</li>\n<li><strong>本AS中不是本地设备的EBGP邻居学到的路由度量值会清零</strong>，导致选路问题；所以建立所有存在<strong>EBGP邻居的边界IBGP路由器均宣告</strong>本AS中<strong>路由条目</strong></li>\n<li>作用：用于其他AS判断多个EBGP邻居，谁离目标更近</li>\n</ul>\n</li>\n<li><p>配置：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">network [IP网段] [子网掩码/长度]</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"3-查看BGP表和详情属性：\"><a href=\"#3-查看BGP表和详情属性：\" class=\"headerlink\" title=\"3.查看BGP表和详情属性：\"></a>3.查看BGP表和详情属性：</h4><ul>\n<li><p>查看BGP 邻居表摘要：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp peer </span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>peer</td>\n<td>对方的更新源地址</td>\n</tr>\n<tr>\n<td>V（version）</td>\n<td>bgp版本号</td>\n</tr>\n<tr>\n<td>AS</td>\n<td>自治系统号</td>\n</tr>\n<tr>\n<td>MsgRcvd</td>\n<td>收到了多少信息</td>\n</tr>\n<tr>\n<td>MsgSent</td>\n<td>发送了多少信息</td>\n</tr>\n<tr>\n<td>OutQ</td>\n<td>出项消息队列</td>\n</tr>\n<tr>\n<td>Up &#x2F; Down</td>\n<td>邻居建立时间</td>\n</tr>\n<tr>\n<td>PrefRcv</td>\n<td>收到了多少路由更新数量</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>查看BGP 邻居表详情：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp peer verbose </span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>字段名</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Configured（已配置）</td>\n<td>本地配置的hold超时时间，keepalive保活时间</td>\n</tr>\n<tr>\n<td>Received（接收到）</td>\n<td>对方配置的hold超时时间，keepalive保活时间</td>\n</tr>\n<tr>\n<td>Negotiated（协商后）</td>\n<td>双方协商后的hold超时时间，keepalive保活时间</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>查看BGP 路由表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp routing-table</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>status codes状态码</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>* - valid</td>\n<td>有效路由，目标网段加到路由表的条件之一</td>\n</tr>\n<tr>\n<td>&gt; - best</td>\n<td>最优路由，目标网段加到路由表的条件之一</td>\n</tr>\n<tr>\n<td>d - damped</td>\n<td>惩罚路由</td>\n</tr>\n<tr>\n<td>h - history</td>\n<td>惩罚路由</td>\n</tr>\n<tr>\n<td>i- internal</td>\n<td>IBGP邻居学习到的路由</td>\n</tr>\n<tr>\n<td>s - suppressed</td>\n<td>路由抑制</td>\n</tr>\n<tr>\n<td>s - stale</td>\n<td>陈旧路由</td>\n</tr>\n</tbody></table>\n<table>\n<thead>\n<tr>\n<th>Origin起源码</th>\n<th>说明，路由最早来源的地方</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>i - IGP</td>\n<td>自身通告路由（network）</td>\n</tr>\n<tr>\n<td>e - BGP</td>\n<td>来自BGP的路由</td>\n</tr>\n<tr>\n<td>? - incomplete</td>\n<td>无知起源路由（重发布路由），通过重发布，将IGP产生的路由发布到BGP</td>\n</tr>\n</tbody></table>\n<table>\n<thead>\n<tr>\n<th>列表属性字段</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>MED</td>\n<td>度量</td>\n</tr>\n<tr>\n<td>NextHop</td>\n<td>下一跳</td>\n</tr>\n<tr>\n<td>LocPrf</td>\n<td>本地优先级</td>\n</tr>\n<tr>\n<td>PrefVal</td>\n<td>权重属性（虚拟优先级）</td>\n</tr>\n<tr>\n<td>Origin</td>\n<td>起源</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>查看BGP的IP路由表</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display ip routing-table protocol bgp</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>BGP 路由优先级</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>EBGP：255</td>\n<td></td>\n</tr>\n<tr>\n<td>IBGP：255</td>\n<td></td>\n</tr>\n<tr>\n<td>Local BGP ： 255</td>\n<td></td>\n</tr>\n</tbody></table>\n</li>\n<li><p>注意：</p>\n<ul>\n<li>EBGP邻居之间传递路由最小间隔为30S</li>\n<li>IBGP邻居之间传递路由最小间隔为15S</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"4-开启负载均衡：\"><a href=\"#4-开启负载均衡：\" class=\"headerlink\" title=\"4.开启负载均衡：\"></a>4.开启负载均衡：</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load-balancing as-path-ignore     # 先进入BGP进程，仅对EBGP路由有效</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">负载均衡的两条线路对端必须指向同一AS，且在BGP表中仅显示最佳，但路由表中出现负载均衡现象</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"4-路由不优的问题：\"><a href=\"#4-路由不优的问题：\" class=\"headerlink\" title=\"4.路由不优的问题：\"></a>4.路由不优的问题：</h4><ul>\n<li><p>原因：1.下一跳不可达 2.IBGP同步</p>\n</li>\n<li><p>下一跳属性规则：</p>\n<ul>\n<li>network 引入 默认next-hop 属性为0.0.0.0 </li>\n<li>network通告路由传递给IBGP邻居或EBGP邻居时，下一跳默认为更新源地址（即建立TCP三次握手的对方IP地址）</li>\n<li>IBGP学习路由传递给EBGP邻居时，下一跳为EBGP的更新源地址（EBGP邻居路由传递给EBGP邻居时也一样）</li>\n<li><strong>EBGP学习路由传递给IBGP邻居时，下一跳不发生改变</strong></li>\n</ul>\n</li>\n<li><p>修改下一跳为本地： 只将本设备通过EBGP学习到的路由传给下一个路由器时显示的下一跳修改成本设备</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端IP地址] next-hop-local</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">联邦内的EBGP关系，传递的路由其属性遵循IBGP关系，传递性遵循EBGP关系</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>备注：</p>\n<ul>\n<li>在思科中，默认将IGP协议通告进入BGP时，将原IGP路由的下一跳地址作为BGP路由的下一跳属性；传递给其他IBGP邻居时，IBGP邻居发现路由的下一跳属性为自己的接口地址，启用下一跳防环机制，组织路由加表，下一跳属性具有防环功能</li>\n<li>在华为中，将路由通告在BGP时，下一跳属性为0.0.0.0，并且传递给其他IBGP邻居时下一跳属性直接变为更新源地址，下一跳属性不存在放环功能，再修改优先级的时候可能导致路由环路。</li>\n</ul>\n</li>\n<li><p><strong>特殊说明：</strong></p>\n<ul>\n<li><p>路由器R1、R2、R3（R1、R2为IBGP邻居，R1和R3、R2和R3为EBGP邻居）在同一个MA网段；但IBGP邻居两在同一个AS，EBGP邻居不在同一个AS；</p>\n</li>\n<li><p>正常R1从R2学习到R4传递给R3的路由，下一跳自动显示为R3（最佳路径）</p>\n</li>\n<li><p>形成条件：</p>\n<ul>\n<li>R1、R2、R3必须使用MA网段的物理接口建立邻居关系</li>\n<li>ICMP重定向开启（默认开启）</li>\n</ul>\n</li>\n<li><p>ICMP重定向：一台路由器在转发一个流量时，发现<strong>流量在本地的入口和查询完路由表的出口为同一个接口</strong>，告知上一跳设备本地的下一跳地址，帮助上一跳设备找到最佳的下一跳地址</p>\n</li>\n<li><p>在BGP中仅查看某各邻居发送或接收到的BGP路由</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp routing-table peer [对端更新源地址] [received-routes/advertised-routes]</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">received-routes：接收到的路由</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">advertised-routes：发送的路由</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h4 id=\"5-对等体组：\"><a href=\"#5-对等体组：\" class=\"headerlink\" title=\"5.对等体组：\"></a>5.对等体组：</h4><ul>\n<li><p>将多个peer 划入一个group中，针对group实施BGP邻居关系建立的配置</p>\n</li>\n<li><p>优点：</p>\n<ul>\n<li>减少BGP配置</li>\n<li>将多个peer划入一个group仅仅针对一个group一次性消耗CPU 内存等资源，所以可以节约资源</li>\n</ul>\n</li>\n<li><p>创建group</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">group [组名] [internal/external]   # 默认internal（IBGP）</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改更新源：（因为在同一AS中，不需要单独建立BGP邻居命令as-number ）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [组名] connect-interface [本地的环回接口号]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>将peer划入对等体组：将想和本设备建立邻居的更新源加入组中，对端路由同种操作 </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [IP地址] group [组名]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp peer</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"6-路由反射器：\"><a href=\"#6-路由反射器：\" class=\"headerlink\" title=\"6.路由反射器：\"></a>6.路由反射器：</h4><ul>\n<li><p>反射规则： 非非不传（非客户端收到的路由不能传递给其他的非客户端）</p>\n</li>\n<li><p>在路由反射器中，由于破坏了IBGP水平分割机制，可能导致路由环路，所以引入了<strong>起源者属性</strong>和<strong>簇ID属性</strong>进行防环</p>\n</li>\n<li><p>起源者属性：反射器中心学习到路由的路由器RID作为起源者属性，表明这条路由最早源于这个IBGP路由器</p>\n</li>\n<li><p>簇ID属性：在反射路由时，将簇ID（cluster-id）写到此条路由的簇ID列表中。来证明这条路由被反射过</p>\n</li>\n<li><p>设置路由反射器： 设置<strong>路由反射器</strong>的<strong>客户端</strong>，同时宣告自身为<strong>路由反射器中心</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端IP地址] reflect-client    # 设置对端为本设备的客户端，本设备为中心；中心将学到的路由传递给客户端</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>可选：设置路由反射器的cluster-id：（防环）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">reflector cluster-id [RRID]     # 设置本设备的簇ID，默认为本设备的RID</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看反射之后的路由：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp routing-table [路由IP网段]   # 在反射器之后的设备查看</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"7-EBGP联邦：\"><a href=\"#7-EBGP联邦：\" class=\"headerlink\" title=\"7.EBGP联邦：\"></a>7.EBGP联邦：</h4><ul>\n<li><p><strong>先部署小AS，再声明大AS</strong></p>\n</li>\n<li><p>注意： 联邦EBGP邻居既有IBGP邻居特性又有EBGP邻居特性</p>\n</li>\n<li><p>IBGP特性：</p>\n<ul>\n<li>下一跳问题 </li>\n<li>学习到的路由标记为IBGP</li>\n</ul>\n</li>\n<li><p>EBGP特性：邻居建立过程中存在EBGP邻居的非直连检测和TTL问题</p>\n</li>\n<li><p>联邦EBGP防环：引入联邦AS序列号进行防环（不AS-path 区别 1.不计入选路 2.当传递出大的AS时消失）</p>\n</li>\n<li><p>配置：</p>\n<ol>\n<li><p>在同一个联邦内的路由器配置小AS</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bgp [AS号]</span><br><span class=\"line\">router-id [路由器RID]</span><br><span class=\"line\">peer ......</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>声明大的AS号：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">confederation id [AS号]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在需要建立联盟EBGP之间指定peer-as（需要先声明，再建立了EBGP邻居）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">confederation peer-as [对方的AS号]   # 联盟内小AS与小AS建立EBGP邻居前，需要互相指定对方的AS号</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改EBGP邻居之间的条数</p>\n</li>\n<li><p>查看接收到的联邦 IBGP邻居路由和联邦 EBGP邻居路由</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp routing-table []</span><br></pre></td></tr></table></figure></li>\n</ol>\n</li>\n</ul>\n<h4 id=\"8-BGP的社团属性：\"><a href=\"#8-BGP的社团属性：\" class=\"headerlink\" title=\"8.BGP的社团属性：\"></a>8.BGP的社团属性：</h4><ul>\n<li><p>社团属性：可选可传递属性</p>\n</li>\n<li><p>标准社团属性：针对传递的路由信息进行标记</p>\n</li>\n<li><p>扩展社团属性：抓取路由属性，进行选路</p>\n</li>\n<li><p><strong>默认不传播，不存在</strong></p>\n</li>\n<li><h3 id=\"标准社团属性配置：\"><a href=\"#标准社团属性配置：\" class=\"headerlink\" title=\"标准社团属性配置：\"></a>标准社团属性配置：</h3><ul>\n<li><p>添加社团属性：</p>\n<ol>\n<li><p>设置策略列表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-policy [列表名] permit node [序列号]</span><br><span class=\"line\">if-match [条件]</span><br><span class=\"line\">apply community [社团属性/num:num]</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">已定义的社团属性：Internet可以传递给所有邻居，no-advertise不能传递给任何邻居</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">                no-export不能传递出大的AS，no-export-subconfed不能传递出小的AS</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端更新源地址] route-policy [列表名] [import/export]     # 先进入BGP进程</span><br></pre></td></tr></table></figure></li>\n</ol>\n</li>\n<li><p>向对端传播标准社团属性：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端更新源地址] advertise-community     # 先进入BGP进程，传递标准团体属性</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在其他路由器查看社团属性：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp routing-table [路由网段]</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><h3 id=\"扩展社团属性配置：\"><a href=\"#扩展社团属性配置：\" class=\"headerlink\" title=\"扩展社团属性配置：\"></a>扩展社团属性配置：</h3><ul>\n<li><p>添加社团属性：</p>\n<ol>\n<li><p>使用社团属性列表抓取扩展团体属性</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip community-filter basic [列表名] permit [num]:[num]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置策略列表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-policy [列表名] permit node [序列号]</span><br><span class=\"line\">if-match community-filter [列表名]</span><br><span class=\"line\">apply [选路属性] [num]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端更新源地址] route-policy [列表名] [import/export]     # 先进入BGP进程</span><br></pre></td></tr></table></figure></li>\n</ol>\n</li>\n<li><p>向对端传播扩展社团属性：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端更新源地址] advertise-ext-community     # 先进入BGP进程，传递扩展团体属性</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在其他路由器查看社团属性：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp routing-table [路由网段]</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h4 id=\"9-BGP的自动汇总：（可选）\"><a href=\"#9-BGP的自动汇总：（可选）\" class=\"headerlink\" title=\"9.BGP的自动汇总：（可选）\"></a>9.BGP的自动汇总：（可选）</h4><ul>\n<li><p>自动汇总只针对重发布的路由</p>\n</li>\n<li><p>当代的路由器设备，<strong>默认就关闭了BGP的自动汇总功能</strong></p>\n</li>\n<li><p>自动汇总规则与正常BGP协议共享，或在BGP协议通过network宣告命令产生的路由条目无关</p>\n</li>\n<li><p>宣告由于重发布</p>\n</li>\n<li><p>在开启了自动汇总的前提下，重发布进入的路由将不携带子网掩码，按主类掩码进入；不携带本地到目标网段的度量值，度量值为0；若关闭自动汇总，进入路由将正常携带掩码，且携带度量，此时和宣告路由仅起源属性不同；<strong>故建议不要开启自动汇总</strong></p>\n</li>\n<li><p>配置：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">summary automatic   # 开启自动汇总，一般不开启；先进入BGP进程 </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import-route [其他协议名] [进程号]      # 批量宣告网络</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"10-BGP的认证：\"><a href=\"#10-BGP的认证：\" class=\"headerlink\" title=\"10.BGP的认证：\"></a>10.BGP的认证：</h4><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端的更新源地址] password cipher [密码]   # 先进入BGP进程，邻居间需要密钥一致</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"11-BGP聚合（汇总）：\"><a href=\"#11-BGP聚合（汇总）：\" class=\"headerlink\" title=\"11.BGP聚合（汇总）：\"></a>11.BGP聚合（汇总）：</h4><ul>\n<li><p>利用BGP的宣告特征来简化了汇总配置量</p>\n</li>\n<li><p>宣告特征：本地路由表中任何方式产生的路由均可被BGP宣告</p>\n</li>\n<li><p>在实际工程中，由于AS之间一定存在大量的EBGP邻居关系，因此仅汇总不能做到优选路径，必须在传递聚合条目的同时，再传递部分的明细路由来选路控制</p>\n</li>\n<li><p>在进行路由聚合时，会丢弃某些属性（AS-Path等），导致网络故障（严重的会出现路由环路），还有一些属性会自动生成一些默认值</p>\n</li>\n<li><p>配置：</p>\n<ul>\n<li><p>方式一：</p>\n<ol>\n<li><p>不宣告各明细网段</p>\n</li>\n<li><p>配置汇总网段的空接口：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip route-static [汇总网段地址] [子网掩码/长度] null 0</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>宣告汇总网段：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">network [汇总网段]</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">如果需要个别明细路由，直接再宣告明细网段</span></span><br></pre></td></tr></table></figure></li>\n</ol>\n</li>\n<li><p>方式二：</p>\n<ol>\n<li><p>汇总明细路由</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">   aggregate [汇总后的网段] [子网掩码/长度]     # 此时聚合与所有明细条目均传递</span><br><span class=\"line\">   aggregate [汇总后的网段] [子网掩码/长度] detail-suppressed   # 仅仅发送聚合路由，抑制所有的明细路由发送</span><br><span class=\"line\"><span class=\"meta prompt_\">   # </span><span class=\"language-bash\">detail-suppressed：仅仅发送聚合路由，抑制所有的明细路由发送</span></span><br><span class=\"line\"><span class=\"meta prompt_\">   # </span><span class=\"language-bash\">suppress-policy：使用抑制列表进行控制，抑制匹配的路由</span></span><br><span class=\"line\"><span class=\"meta prompt_\">   # </span><span class=\"language-bash\">origin-policy：针对此列表中匹配的路由存在时，聚合才会生效</span></span><br><span class=\"line\"><span class=\"meta prompt_\">   # </span><span class=\"language-bash\">attribute-policy：仅仅针对聚合路由进行策略控制</span></span><br><span class=\"line\"><span class=\"meta prompt_\">   # </span><span class=\"language-bash\">as-set：可以还原聚合路由中丢失的某些属性（例As-Path）</span></span><br><span class=\"line\"></span><br><span class=\"line\">2. 配置汇总网段的空接口：</span><br><span class=\"line\">  </span><br><span class=\"line\">     ```shelll</span><br><span class=\"line\">     ip route-static [汇总网段地址] [子网掩码/长度] null 0</span><br></pre></td></tr></table></figure></li>\n</ol>\n</li>\n<li><p>路由传递干涉策略：</p>\n<ol>\n<li><p><strong>※</strong> 抑制列表：<strong>抑制抓取到路由网段</strong></p>\n<ul>\n<li><p>抓取流量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip ip-prefix [列表名] permit [目标IP网段] [子网掩码/长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置策略列表</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-policy [列表名] permit node [序列号]</span><br><span class=\"line\">if-match ip-prefix [列表名]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在BGP中调用抑制列表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">aggregate [汇总网段] [子网掩码/长度] suppress-policy [策略列表名]    # 先进入BGP进程</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>Route-map：在BGP中将route-map当分发列表用，<strong>抑制抓取到路由网段</strong></p>\n<ul>\n<li><p>先做了没有抑制明细路由的汇总</p>\n</li>\n<li><p>抓取流量：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip ip-prefix [列表名] permit [目标IP网段] [子网掩码/长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置策略列表，拒绝抓取流量网段</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-policy [列表名] deny node [序列号]</span><br><span class=\"line\">if-match ip-prefix [列表名]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在BGP中调用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [邻居的更新源地址] route-policy [策略列表名] export       # 先进入BGP进程</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">export</span>：控制层面的出项(路由传递出的方向)</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">import：控制层面的入向</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>分发列表：抑制抓取到路由网段</p>\n<ul>\n<li><p>先做了没有抑制明细路由的汇总</p>\n</li>\n<li><p>抓取流量：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip ip-prefix [列表名] deny [目标IP网段] [子网掩码/长度]</span><br><span class=\"line\">ip ip-prefix [列表名] permit 0.0.0.0 0 less-equal 32</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在BGP中调用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">filter-policy ip-prefix [列表名] export       # 先进入BGP进程</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\"><span class=\"built_in\">export</span>：控制层面的出项(路由传递出的方向)</span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">import：控制层面的入向</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p><strong>※</strong> 前缀列表：BGP协议中可以直接将前缀列表作为分发列表调用，抑制抓取到路由网段</p>\n<ul>\n<li><p>先做了没有抑制明细路由的汇总</p>\n</li>\n<li><p>抓取流量：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip ip-prefix [列表名] deny [目标IP网段] [子网掩码/长度]</span><br><span class=\"line\">ip ip-prefix [列表名] permit 0.0.0.0 0 less-equal 32</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在BGP中调用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [邻居的更新源地址] ip ip-prefix [列表名] export     # 先进入BGP进程</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ol>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"12-BGP-路由惩罚：\"><a href=\"#12-BGP-路由惩罚：\" class=\"headerlink\" title=\"12.BGP 路由惩罚：\"></a>12.BGP 路由惩罚：</h4><ul>\n<li><p>目的：抑制路由的摆动（过于频繁的通告路由和撤销路由）</p>\n</li>\n<li><p>特点：</p>\n<ul>\n<li>被惩罚的路由<strong>不能参与选路，不能加入本地的IP路由表，不能传递</strong></li>\n<li>路由惩罚<strong>仅仅针对EBGP邻居学习</strong>的路由</li>\n</ul>\n</li>\n<li><p>惩罚值：路由条目每翻滚（宣告与取消宣告）一次，惩罚值增加1000，路由属性每翻滚一次惩罚值增加500（不可修改），华为中<strong>最大惩罚值 默认为16000</strong> </p>\n</li>\n<li><p>惩罚门限：超过了惩罚门限开启进行路由惩罚，默认值为2000</p>\n</li>\n<li><p>重用门限：当惩罚值低于该值，重新使用该路由信息，默认为750</p>\n</li>\n<li><p>半衰期：默认为15分钟，每过设置时间惩罚值减低一半</p>\n</li>\n<li><p>配置：</p>\n<ol>\n<li>启用BGP路由惩罚：</li>\n</ol>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">dampening [半衰期时间] [重用门限值] [惩罚门限值] [最大惩罚值]</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">半衰期：默认为15分钟，重用门限：默认为750，惩罚门限：默认值为2000，最大惩罚值：16000</span></span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>查看路由惩罚参数：</li>\n</ol>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp routing-table dampening parameter</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li>查看被惩罚的路由：</li>\n</ol>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp routing-table dampened</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>（重启）清楚所有被惩罚的路由信息：</li>\n</ol>\n  <figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">reset bgp dampening     # 在用户模式下</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"13-BGP的选路规则：\"><a href=\"#13-BGP的选路规则：\" class=\"headerlink\" title=\"13.BGP的选路规则：\"></a>13.BGP的选路规则：</h4><ul>\n<li><p>选路条件：<strong>BGP路由必须有效，无环的，不能被惩罚</strong></p>\n</li>\n<li><p>规则：（前提：多条BGP路由目标相同，且均可优（下一条可达，同步关闭））</p>\n<ol>\n<li>优选权重值最高的路由（本地属性，不传递，权限最高的属性，可以干涉EBGP&#x2F;IBGP选路）</li>\n<li>优选本地优先级最高的路由（<strong>IBGP邻居间传递，最常干涉IBGP关系的选路</strong>）</li>\n<li>优选 next-hop为 0.0.0.0 最优先</li>\n<li>优选AS_Path短的路由（EBGP&#x2F;IBGP关系均可被干涉，但只能在EBGP邻居间修改）</li>\n<li>优选Origin起源类型 IGP &gt; EGP &gt; Incomplete（可在控制层面任意接口修改）</li>\n<li>优选来组同一AS的路由MED值最小的（<strong>最常干涉EBGP选路的属性</strong>）</li>\n</ol>\n</li>\n<li><p>如果<strong>属性</strong>无法解决选路问题，需要考虑如下</p>\n<ol>\n<li>优选从EBGP学来的路由（联邦EBGP当做普通IBGP路由对待）</li>\n<li>优先AS内部IGP的Metric最小的路由</li>\n<li>优选Cluster_List最短的路由</li>\n<li>优选Orginator_ID最小的路由</li>\n<li>优选Router_ID最小的路由器发布的路由</li>\n<li>优选具有较小IP地址的邻居学来的路由</li>\n</ol>\n</li>\n<li><p>负载分担：去往不同的目标，将流量分担不同的链路上</p>\n</li>\n<li><p>负载均衡：到同一个目标基于多条路径同时传输</p>\n</li>\n<li><p>针对属性的修改来实现负载分担，正常时在BGP协议控制层面流量的入或出口上匹配信息，修改属性</p>\n</li>\n</ul>\n<p><img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221129205019958.png\" alt=\"image-20221129205019958\"></p>\n<ul>\n<li><p>如果属性没有生效，可以使用软清除：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">refresh bgp [更新源地址]     # 用户模式下</span><br></pre></td></tr></table></figure>\n</li>\n<li><h3 id=\"权重属性：PrefVal\"><a href=\"#权重属性：PrefVal\" class=\"headerlink\" title=\"权重属性：PrefVal\"></a>权重属性：PrefVal</h3><ul>\n<li><table>\n<thead>\n<tr>\n<th>属性名</th>\n<th>传播范围</th>\n<th>默认值</th>\n<th>取值范围</th>\n<th>优先</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>权重</td>\n<td>不传播，本地有效（私有）</td>\n<td>0</td>\n<td>0 - 65535</td>\n<td>越大越优</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>修改对端传递过来的路由权重（全局修改）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端的更新源地址] preferred-value [权重值]    # 先进入BGP进程</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改对端传递过来的部分路由权重</p>\n<ol>\n<li><p>抓取流量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip ip-prefix [列表名] index [序列号] [deny/permit] [IP地址/IP网段] [网络号固定长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置策略列表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-policy [列表名] permit node [序列号]</span><br><span class=\"line\">if-match ip-prefix [列表名]</span><br><span class=\"line\">apply preferred-value [权重值]</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">加上空表，表示过行其他所有</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在BGP中调用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端更新源地址] route-policy [列表名] import     # 先进入BGP进程，本地生效所以export是不生效的</span><br></pre></td></tr></table></figure></li>\n</ol>\n</li>\n</ul>\n</li>\n<li><h3 id=\"本地优先级：LocPrf\"><a href=\"#本地优先级：LocPrf\" class=\"headerlink\" title=\"本地优先级：LocPrf\"></a>本地优先级：LocPrf</h3><ul>\n<li><table>\n<thead>\n<tr>\n<th>属性名</th>\n<th>传播范围</th>\n<th>默认值</th>\n<th>取值范围</th>\n<th>优先</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>本地优先级</td>\n<td>IBGP邻居间</td>\n<td>100</td>\n<td>0 - 255</td>\n<td>越大越优</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>最常用于干涉IBGP选路，在边界路由器上修改（影响离开本AS的流量）</p>\n</li>\n<li><p>修改本地优先级：（全局）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">defalut local-preference [优先值]      # 先进入BGP</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>修改本地优先级：（部分），本设备所学到的路由传递给对端时的本地优先级</p>\n<ol>\n<li><p>抓取流量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip ip-prefix [列表名] permit [IP网段] [子网掩码/长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置策略列表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-policy [列表名] permit node [序列号]</span><br><span class=\"line\">apply local-preference [优先值]</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">加上空表，表示过行其他所有</span>\t </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在BGP中调用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端更新源地址] route-policy [列表名] export     # 先进入BGP进程，export我方把路由传出的方向</span><br></pre></td></tr></table></figure></li>\n</ol>\n</li>\n</ul>\n</li>\n<li><h3 id=\"下一跳：NextHop\"><a href=\"#下一跳：NextHop\" class=\"headerlink\" title=\"下一跳：NextHop\"></a>下一跳：NextHop</h3></li>\n<li><h3 id=\"路径：AS-Path\"><a href=\"#路径：AS-Path\" class=\"headerlink\" title=\"路径：AS-Path\"></a>路径：AS-Path</h3><ul>\n<li><p>一条目在传递过程中将记录所有经过的AS编号，优选经过的AS数量最小的路径</p>\n</li>\n<li><p>AS-PATH只能在真正的EBGP关系间传递时可以添加（<strong>不能减少</strong>）</p>\n</li>\n<li><p>因为该属性同时用于EBGP水平分割：若存在本地AS号，将拒绝该条目</p>\n</li>\n<li><p>即可干涉EBGP关系，也可干涉IBGP关系选路，但<strong>修改时只能在EBGP关系进行</strong></p>\n</li>\n<li><p>修改AS-PATH：</p>\n<ol>\n<li><p>抓取流量： </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip ip-prefix [列表名] permit [IP网段] [子网掩码/长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置策略列表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-policy [列表名] permit node [序列号]</span><br><span class=\"line\">apply as-path [AS号] ..... additive</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">加上空表，表示过行其他所有</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在BGP中调用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端更新源地址] route-policy [列表名] [export/import]     # 先进入BGP进程，我方和对方 相对路由传递的入或出方向</span><br></pre></td></tr></table></figure></li>\n</ol>\n</li>\n</ul>\n</li>\n<li><h3 id=\"起源：Origin\"><a href=\"#起源：Origin\" class=\"headerlink\" title=\"起源：Origin\"></a>起源：Origin</h3><ul>\n<li><p>修改Origin：</p>\n<ol>\n<li><p>抓取流量： </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip ip-prefix [列表名] permit [IP网段] [子网掩码/长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置策略列表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-policy [列表名] permit node [序列号]</span><br><span class=\"line\">apply origin [i/e/?] [1/2]     # 1:代表入口处修改，2：代表出口处修改</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">加上空表，表示过行其他所有</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在BGP中调用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端更新源地址] route-policy [列表名] [export/import]     # 先进入BGP进程</span><br></pre></td></tr></table></figure></li>\n</ol>\n</li>\n</ul>\n</li>\n<li><h3 id=\"度量：MED\"><a href=\"#度量：MED\" class=\"headerlink\" title=\"度量：MED\"></a>度量：MED</h3><ul>\n<li><p>多出口的鉴别属性</p>\n</li>\n<li><p>BGP协议自身没有度量值；只有在宣告本地路由或重发布IGP到BGP时，携带IGP度量，度量值在MED处显示</p>\n</li>\n<li><p>管理员可以利用该属性，来实现干涉选路（最常用于干涉EBGP关系选路，常常用于AS1干涉AS2对AS1的选路）</p>\n</li>\n<li><p>修改MED：</p>\n<ol>\n<li><p>抓取流量： </p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip ip-prefix [列表名] permit [IP网段] [子网掩码/长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置策略列表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-policy [列表名] permit node [序列号]</span><br><span class=\"line\">apply cost [度量值]</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">加上空表，表示过行其他所有</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在BGP中调用：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [对端更新源地址] route-policy [列表名] [export/import]     # 先进入BGP进程</span><br></pre></td></tr></table></figure></li>\n</ol>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"9-MPLS多协议标签交换：\"><a href=\"#9-MPLS多协议标签交换：\" class=\"headerlink\" title=\"9.MPLS多协议标签交换：\"></a>9.MPLS多协议标签交换：</h3><h4 id=\"1-概念：-1\"><a href=\"#1-概念：-1\" class=\"headerlink\" title=\"1.概念：\"></a>1.概念：</h4><ul>\n<li><p>标签交换：</p>\n<ul>\n<li>第一跳路由器在数据包中的第2.5层压入一个标签号，</li>\n<li>从第二跳路由器开始仅基于标签号，查询本地的LFIB表转发数据即可；由最后一跳路由器弹出标签</li>\n<li>标签的意义在于更快的查；但随着包交换的加速，使用标签交换失去了快速查表的优势</li>\n</ul>\n</li>\n<li><p>包交换：基于3层（IP地址）数据进行转发</p>\n<ul>\n<li>快速交换：一次路由，多次交换</li>\n<li>特快交换：无需路由，直接交换</li>\n</ul>\n</li>\n<li><p>三层网络设备的数据处理方式：</p>\n<ul>\n<li><p>进程转发：基于数据包的处理方式，每数据包每个路由</p>\n</li>\n<li><p>快速转发：基于数据流的处理方式，每数据流每路由一次</p>\n</li>\n<li><p>CEF转发（思科私有技术）：基于拓扑的数据处理方式，无需路由直接转发</p>\n</li>\n</ul>\n</li>\n<li><h3 id=\"当下MPLS多协议标签交换存在的意义：\"><a href=\"#当下MPLS多协议标签交换存在的意义：\" class=\"headerlink\" title=\"当下MPLS多协议标签交换存在的意义：\"></a>当下MPLS多协议标签交换存在的意义：</h3><ol>\n<li>解决BGP的路由黑洞</li>\n<li>MPLS VPN</li>\n<li>MPLS TE 流量工程</li>\n</ol>\n</li>\n<li><p>另外，随着包交换的加速，使得今天的MPLS技术也开始基于FIB表工作，来提高MPLS的工作效率</p>\n</li>\n<li><p>MPLS当下需要基于特快交换来进行</p>\n</li>\n<li><p>名词解析：</p>\n<ul>\n<li>RIB：路由表；</li>\n<li>FIB：转发信息数据库，IP路由表的升级</li>\n<li>LIB：标签信息数据库，存储到达每一个网段的标签信息</li>\n<li>LFIB：FIB+LIB，标签转发信息数据库，MPLS技术使用该信息库进行标签的交换数据的传输</li>\n<li>MPLS domain：MPLS的工作半径</li>\n<li>LSR：标签交换路由表，标签的swap交换</li>\n<li>edge LSR（PE）：边界标签交换路由器，工作MPLS域的边缘，连接域外设备</li>\n<li>LSP：标签交换路由表，整体工作MPLS域内</li>\n</ul>\n</li>\n<li><p>LDP：</p>\n<ul>\n<li>基于UDP和TCP的646端口工作</li>\n<li>先使用UDP发送组播hello包发现邻居，获取邻居IP地址，再和该直连邻居建立TCP的会话；邻居关系建立后，为了邻居关系间的稳定，<strong>一般使用设备的环回地址来建立TCP会话</strong>；</li>\n<li><strong>建议设置环回地址为MPLS协议的 route-id</strong> ，该id值将携带在组播收发的hello报文中，之后自动进行TCP会话建立</li>\n<li>当发送keepalive时，标志这LDP会话建立完成；使用advertise通告传递label信息</li>\n</ul>\n</li>\n<li><p>标签交换的控制层面协议（标签的分配和传输协议）：LDP（MPLS），MP-BGP（MPLS-VPN），RSVP（MPLS-TE）</p>\n</li>\n<li><p>控制层面：</p>\n<ol>\n<li>在没有MPLS时控制层仅生成RIB表和FIB表，FIB是基于RIB生成的</li>\n<li>MPLS协议会启动TDP（cisco思科）或LDP（公有），直连设备间将建立邻居关系</li>\n<li>MPLS在建立邻居关系后，生成邻居表；LDP协议再基于FIB表中学习到的路由条目生成标签号</li>\n<li>标签号生成后，将存储于本地的LIB表，LIB表将在邻居间共享</li>\n<li>运行MPLS协议的设备，将LIB和FIB进行过结合，将标签号和最佳路径的关系映射生成LFIB表</li>\n</ol>\n</li>\n<li><h3 id=\"数据层面：\"><a href=\"#数据层面：\" class=\"headerlink\" title=\"数据层面：\"></a>数据层面：</h3><ol>\n<li><strong>第一跳路由器</strong>查看FIB表，将目标网段的出项标签<strong>压入</strong>数据包</li>\n<li>中间路由器仅基于2.5层的标签号查询本地的LFIB表，如果数据包中的标签号和LFIB表中的入标签相同，将数据包中的标签号替换成出项标签，通过对应的端口转发出去。</li>\n<li>最后一跳路由器负责弹出标签（数据包中的标签号和入标签相同，且出标签为NULL，去除数据包中的标签，然后查看FIB表根据对应的下一条和转出接口转发数据）</li>\n</ol>\n</li>\n<li><p>MPLS中的标签号：</p>\n<ul>\n<li><p>标签被压入在第2层与3层之间，称为2.5层</p>\n</li>\n<li><p>标签的格式：32位，4个字节</p>\n<p><img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221129093610927.png\" alt=\"image-20221129093610927\"></p>\n</li>\n<li><p>Label标签位：前20位，20bit，有2^20个标签号，其中0-15号保留，作为特殊编号；华为中16-1023代表静态MPLS技术使用的标签</p>\n</li>\n<li><p>EXP策略位：前21-23位，3bit，默认000，为优先级，用于QOS策略使用</p>\n</li>\n<li><p>栈底位：第24位，1个bit，S&#x3D;0代表未到达栈底，S&#x3D;1到达栈底</p>\n</li>\n<li><p>TTL：生存时间8bit，在第一次压入标签时，将当前数据包中的3层TTL复制到标签中，之后查询一次标签TTL减一，在最后一跳设备弹出标签时将2.5层的TTL复制到3层报头中。</p>\n</li>\n</ul>\n</li>\n<li><p>MPLS的次末跳：倒数第二跳，<strong>默认执行</strong></p>\n<ul>\n<li>边界LSR将本地的<strong>直连网段</strong>传递给MPLS域内邻居后，LDP分配标签号为3，告知倒数第二跳设备它的身份；</li>\n<li>导致倒数第二跳设备在查询LFIB表后，<strong>已知转发路径的前提下</strong>提前弹出标签，使得最后一跳路由器均只需要查询FIB表；</li>\n<li>否则最后一跳路由器在查询LFIB表后，弹出标签还需要查询FIB（避免目标网段在本设备上，还要去查看FIB表）</li>\n</ul>\n</li>\n<li><p>标签的分配方式：DU下游自主方式，下游按需</p>\n</li>\n</ul>\n<h4 id=\"2-配置：\"><a href=\"#2-配置：\" class=\"headerlink\" title=\"2.配置：\"></a>2.配置：</h4><ul>\n<li><p>路由可达</p>\n</li>\n<li><p>配置MPLS的id</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mpls lsr-id [route-id]   </span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">必须先定义MPLS的router-id，要为本地设备的真实IP地址，且邻居可达；因为该地址将用于建立TCP会话，建议使用环回地址</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>先开启MPLS，再激活LDP协议</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mpls</span><br><span class=\"line\">mpls ldp</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在标签经过的接口处开启MPLS，激活LDP协议</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">先进入接口</span></span><br><span class=\"line\">mpls</span><br><span class=\"line\">mpls ldp</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>当启动配置完成后，邻居间使用UDP报文组播收发hello包；之后基于hello包中的rouer-id地址进行TCP会话的建立</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display tcp status        # 查看是否建立会话</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221129164237832.png\" alt=\"image-20221129164237832\"></p>\n</li>\n<li><p>当TCP会话建立后，邻居间基于TCP会话再建立邻居关系，生成邻居表</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display mpls ldp peer     # 查看ldp邻居表</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221129164354769.png\" alt=\"image-20221129164354769\"></p>\n</li>\n<li><p>再然后基于本地的FIB表，默认华为仅针对32位的主机路由生成标签号；存储于LIB表中，之后邻居间共享LIB表</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display fib               # 查看FIB表 </span><br><span class=\"line\">display mpls ldp lsp      # 查看LIB表，装载本地和邻居为各条路由分配的标签号</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221129170034455.png\" alt=\"image-20221129170034455\"></p>\n<p><img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221129164628694.png\" alt=\"image-20221129164628694\"></p>\n<table>\n<thead>\n<tr>\n<th>标签</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>入标签in</td>\n<td>自己分配的标签</td>\n</tr>\n<tr>\n<td>出标签out</td>\n<td>别人给我的标签</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>最后路由器将LIB和FIB集合，生成最佳路径的标签转发规则 LFIB</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display mpls lsp           # 查看LFIB表</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221129164700182.png\" alt=\"image-20221129164700182\"></p>\n</li>\n<li><p>注：默认华为仅针对32位主机路由分配标签</p>\n</li>\n<li><p>对所有的路由进行标签号的分配（在没有配置此命令之前只会为环回分配标签）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">lsp-trigger all   # 先进入mpls进程，对所有运行mpls的路由器配置</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>追踪目标路由报文的转发路径</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tracert [目标路由网段]</span><br><span class=\"line\">tracert -v [目标路由网段]</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"3-MPLS解决BGP路由黑洞：\"><a href=\"#3-MPLS解决BGP路由黑洞：\" class=\"headerlink\" title=\"3.MPLS解决BGP路由黑洞：\"></a>3.MPLS解决BGP路由黑洞：</h4><ul>\n<li><p>MPLS协议并不会为通过BGP协议学习的路由条目分配标签号，而是在访问这些BGP路由目标网段时，在流量中压入到达这些网段的BGP下一跳设备地址的标签号</p>\n</li>\n<li><p>例：R2从BGP邻居5.5.5.5学习到6.6.6.0网段的路由；R2在访问6.6.6.0网段时，将在是数据包中压入到达5.5.5.5 IP地址的标签号，来穿越中间没有运行BGP协议的设备，实现打破路由黑洞</p>\n</li>\n<li><p>注：华为设备不为BGP协议执行下一跳标签机制，cisco默认执行</p>\n</li>\n<li><p>开启路由基于隧道进行递归查询：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route recursive-lookup tunnel     # 产生BGP路由黑洞的两台设备上配置</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h4 id=\"4-MPLS-VPN：\"><a href=\"#4-MPLS-VPN：\" class=\"headerlink\" title=\"4.MPLS-VPN：\"></a>4.MPLS-VPN：</h4><ul>\n<li><p>两个自治系统AS之间使用虚拟专线将各自的路由转递到对方去，进行私网的通信</p>\n</li>\n<li><p>即；将物理距离上大的网络通过VPN的方式连接到一起</p>\n</li>\n<li><p>控制层面（客户之间的路由传递），CE：客户路由器，P：运营商路由器，PE：运营商别界路由器</p>\n<ul>\n<li><p>阶段1 ： CE端路由传递给PE端，PE端将路由重发布到BGP的空间路由表</p>\n</li>\n<li><p>阶段2：</p>\n<ol>\n<li><p>PE与PE传递路由，传递路由是携带RD参数的（本地区分路由）和RT参数（负责路由的导入和导出）</p>\n</li>\n<li><p>PE之间建立VPNV4-BGP邻居从而传递路由（在华为中，PE设备若不开启MPLS 功能，VPNV4-BGP路由开启了也无</p>\n<p>法传输；若开启MPLS 等功能，可以在PE之间传递VPNV4-BGP 路由；但是路由不优选，所哟需要保证下一跳是可达的）</p>\n</li>\n</ol>\n</li>\n<li><p>阶段3：将BGP路由传递在PE与CE之间的IGP协议中</p>\n</li>\n</ul>\n</li>\n<li><p>数据层面：内层标签是在MP-BGP中传输，外层LDP协议中传递</p>\n<ol>\n<li>CE的数据包来到PE上，查看空间FIB表，打上内层标签（空间路由的标签），再查看FIB表，打上外层标签（对端PE端环回的标签）</li>\n<li>中间路由查询LFIB表，根据外层标签转发数据</li>\n<li>如果是对方PE的直连网段，进行次末跳，撕掉外层标签，然后最后一跳路由器撕掉内层标签；如果不是则到达对方PE端再撕除外层标签，然后撕掉内层标签</li>\n</ol>\n</li>\n<li><p>RD路由区分器 与RT路由目标：</p>\n<ul>\n<li>RD：区分本地不同的VRF空间，防止其他vrf空间的路由传递到路由器混淆，将IPv4路由变成VPNV4路由（RD值+IPv4）</li>\n<li>RT：BGP扩展团体属性，用于对方接受路由时方便识别和区分</li>\n</ul>\n</li>\n<li><p>配置：</p>\n<ul>\n<li><p>IGP公网可达（除空间接口）</p>\n</li>\n<li><p>创建VRF空间，并配置空间接口</p>\n<ul>\n<li><p>创建vrf空间，<strong>只具有本地意义</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip vpn-instance [空间名]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>进入IPv4的配置模式下</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipv4-family</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置路由区分器的RD值：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-distinguisher [num:num] </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置RT值</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vpn-target [num:num]    # 必须与对端的PE端一致，如果需要将两条VPN合拼为一条，那就互相给所在VPN加上对方VPN的RT值</span><br></pre></td></tr></table></figure>\n\n<table>\n<thead>\n<tr>\n<th>后接参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>both</td>\n<td><strong>默认</strong>，我方识别的RT值和打入的RT值相同</td>\n</tr>\n<tr>\n<td>export-extcommunity</td>\n<td>我方识别对端的RT值</td>\n</tr>\n<tr>\n<td>import-extcommunity</td>\n<td>我方打入的RT值，需要对端进行识别</td>\n</tr>\n</tbody></table>\n</li>\n<li><p>进入链接CE端的接口，关联到vrf空间</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int [接口号]</span><br><span class=\"line\">ip binding vpn-instance [空间名]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置私有IP地址</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip address [IP地址] [子网掩码/长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>注：<strong>在关联到vrf空间前不能配置接口IP地址，否则该地址的直连路由将进入公有路由表</strong></p>\n</li>\n<li><p>查看空间路由</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display ip routing-table vpn-instance [空间名]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置完后，加入空间的接口所连的对端路由器可以 ping通我方，但我方无法 ping 通对方；因为我方 ping对方时，查询的不是空间路由表</p>\n</li>\n<li><p>查看空间路由表 ping通空间接口对端的路由</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ping -vpn-instance [空间名] [对端的IP地址]</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>建立ISP之间的IBGP邻居后，VPN -V4路由（num:num IP地址）需要<strong>MP-BGP</strong>来传递 </p>\n<ul>\n<li><p>在IPv4的家族模式中，与对端建立一个VPN-V4的关系（VPNV4-BGP邻居是建立在IBGP邻居路由器上），<strong>用于传递VPN -V4的路由</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">先进入BGP进程</span></span><br><span class=\"line\">ipv4-family vpnv4</span><br><span class=\"line\">peer [对端更新源地址] enable</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看mp-bgp邻居关系：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp vpnv4 all peer </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看mp-bgp的路由表</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp vpnv4 all routing-table</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>在双端的各<strong>私网内配置路由</strong>，在有空间接口的路由器上，需要<strong>进入空间的路由进程</strong>操作：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[协议类型] [进程号] vpn-instance [空间名]    # 在MPLS-plus中PE两端的进程号必须相同，该双端6类LSA为3类LSA</span><br><span class=\"line\">......</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">在空间接口路由器上添加静态路由</span></span><br><span class=\"line\">ip route-static vpn-instance [空间名] [目标IP网段] [子网掩码/长度] [下一跳IP地址]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在IBGP邻居路由器上进行双向重发布：</p>\n<ul>\n<li><p>需要进入bgp的vpn空间内进行重发布</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bgp [进程号]</span><br><span class=\"line\">ipv4-family vpn-instance [空间名]</span><br><span class=\"line\">import-route [协议类型] [进程号]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>私网所使用的路由进程内重发布</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import-route bgp    # 需要先进入协议进程</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>重发布的路由将进入空间路由表，查看空间路由</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display ip routing-table vpn-instance [空间名]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看空间MPLS表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display mpls [MPLS表类型] vpn-instance [空间号</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"5-OSPF-sham\"><a href=\"#5-OSPF-sham\" class=\"headerlink\" title=\"5.OSPF-sham\"></a>5.OSPF-sham</h4><ul>\n<li><p>用于MPLS-VPN的备份链路</p>\n</li>\n<li><p>配置：</p>\n<ul>\n<li><p>创建环回接口，将环回接口加入对应vfr空间，并指定IP地址</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int loopback [接口号]</span><br><span class=\"line\">ip binding vpn-instance [空间名]</span><br><span class=\"line\">ip address [IP地址] [子网掩码/长度]      # 环回接口必须是32位的主机地址</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>将接口网段宣告到vpnv4-bgp的邻居当中</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bgp [进程号]</span><br><span class=\"line\">ipv4-family vpn-instance [空间名]</span><br><span class=\"line\">network [IP地址] [子网掩码/长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置sham-link</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ospf [进程号] vpn-instance [空间名]    </span><br><span class=\"line\">area 0    # 只能在区域0</span><br><span class=\"line\">sham-link [环回源IP地址] [环回目标IP地址]   </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看sham-link</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display ospf sham-link</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>因为到达我方的PE端会走备份链路，所以修改备份链路之间的开销值</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ospf cost [num]     # 先进入接口</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2-IPv6\"><a href=\"#2-IPv6\" class=\"headerlink\" title=\"2.IPv6:\"></a>2.IPv6:</h2><h3 id=\"1-概念：-2\"><a href=\"#1-概念：-2\" class=\"headerlink\" title=\"1.概念：\"></a>1.概念：</h3><ul>\n<li><p>IPv4地址的缺点：</p>\n<ul>\n<li><p>IPv4地址空间不足</p>\n</li>\n<li><p>IPv4具有负载的头部</p>\n</li>\n<li><p>IPv4头部安全性较低</p>\n</li>\n<li><p>IPv4地址不能作为标识符和定位符</p>\n</li>\n</ul>\n</li>\n<li><p>改进IPv4的缺点：</p>\n<ul>\n<li><p>使用私有地址，进行NAT转换</p>\n</li>\n<li><p>DHCP</p>\n</li>\n<li><p>VLSM CIDR</p>\n</li>\n</ul>\n</li>\n<li><p>组成：128位2进制，4位冒分16进制标识（8段4个16进制）</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C0A8:0101:C0A8:0101:C0A8:0101:C0A8:0101 /64      # IPv6使用网络号长度标识子网掩码</span><br><span class=\"line\">简写：</span><br><span class=\"line\">C0A8:101:C0A8:101:C0A8:101:C0A8:101 /64</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>IPv6的地址表示简写时需要注意的问题：</p>\n<ul>\n<li><p>在使用零压缩法时，不能把一个位段内部的有效0也压缩掉</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">例如：不能将FF02:30:0:0:0:0:0:5简写为FF2:3::5</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>:: 双冒号在一个地址中只能出现一次</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">例如：地址0:0:0:2AA:12:0:0:0，不能把它表示为::2AA:12::</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>确定::之间代表了被压缩的多少位0，可以数一下地址中还有多少个位段，然后用8减去这个数，再将结果乘以16</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">例如：在地址FF02:3::5中有3个位段(FF02、3和2)，可以根据公式计算：(8-3)×16=80，则::之间表示有80位的0被压缩</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>特征：</p>\n<ol>\n<li>全球单播地址：同等于IPv4的公有地址，IPv6没有nat地址转换</li>\n<li>可聚合性：IANA组织对全球的地址进行合理分配</li>\n<li>多宿主：一个物理接口可以同时拥有多个不同网段的IPv6地址，但不同接口不能在同一网段</li>\n<li>自动配置：1.DHCP-v6，2.auto-config路由器接口手工配置IPv6地址，然后路由器将自己地址的前缀（网络号）下放给PC，PC将自动使用EUI-64来补充主机位</li>\n<li>即插即用：热插拔</li>\n<li>端到端的链接：不需要NAT</li>\n<li>重编址</li>\n<li>简易的报头：1.没有广播机制，只有组播和单播，2.没有检测盒（因为2和4层均存在效验盒），3.流标签</li>\n<li>安全性和移动性</li>\n<li>IPv4和IPv6共存</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"2-IPv6的报文头：\"><a href=\"#2-IPv6的报文头：\" class=\"headerlink\" title=\"2.IPv6的报文头：\"></a>2.IPv6的报文头：</h3><ul>\n<li><p>IPv4和IPv6的报文头对比：</p>\n<table>\n<thead>\n<tr>\n<th>颜色</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>黄色</td>\n<td>一致</td>\n</tr>\n<tr>\n<td>红色</td>\n<td>取消</td>\n</tr>\n<tr>\n<td>蓝色</td>\n<td>代替</td>\n</tr>\n</tbody></table>\n<p><img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221130144333986.png\" alt=\"image-20221130144333986\"></p>\n</li>\n<li><p>V4中第二列用于分片，V6可以使用扩展首部实现</p>\n</li>\n<li><p>替代字段</p>\n<table>\n<thead>\n<tr>\n<th>IPv4</th>\n<th>IPv6</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>服务类型</td>\n<td>扩展表</td>\n</tr>\n<tr>\n<td>报头长度</td>\n<td>有效负载长度</td>\n</tr>\n</tbody></table>\n</li>\n</ul>\n<h3 id=\"3-IPv6地址分类：\"><a href=\"#3-IPv6地址分类：\" class=\"headerlink\" title=\"3.IPv6地址分类：\"></a>3.IPv6地址分类：</h3><ul>\n<li><p>图示：</p>\n<p><img src=\"C:\\Users\\user\\AppData\\Roaming\\Typora\\typora-user-images\\image-20221130150106793.png\" alt=\"image-20221130150106793\"></p>\n</li>\n<li><p>IPv6地址的分类：</p>\n<ul>\n<li>单播地址：一对一，只有单播地址能作为源地址，也可作为目标地址<ol>\n<li>AGUA全球可聚合单播地址：计划公网使用的IPv6地址，2000::&#x2F;3<ul>\n<li>商用internet地址：2001 :: &#x2F;16</li>\n<li>IPv6兼容性地址：2002 :: &#x2F;16<ul>\n<li>IPV6到IPV4兼容性地址，主要在IPV4向IPV6过渡时使用的技术，自动tunnel使用地址</li>\n<li>将IPV4地址映射至IPV6地址（该IPV4地址为公有地址）：200.1.1.1 &#x2F;24到C8 01 01 01，2002:C801:0101::&#x2F;48</li>\n</ul>\n</li>\n<li>非商用internet地址：3FFF :: &#x2F;16</li>\n</ul>\n</li>\n<li>本地链路地址</li>\n</ol>\n</li>\n<li>组播地址：一对多，作为目标地址<ul>\n<li>FF02::1  ：所有支持组播的路由与所有主机</li>\n<li>FF02::2  ：所有支持组播的路由器</li>\n<li>FF02::9  ：RIPNG</li>\n<li>FF02::1:FFxx:xxxx ：一般用于収送本地信令帧时使用，例如ARP</li>\n</ul>\n</li>\n<li>任意播地址：一到最近</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"4-配置：\"><a href=\"#4-配置：\" class=\"headerlink\" title=\"4.配置：\"></a>4.配置：</h3><ul>\n<li><p>开启全局的ipv6功能：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipv6</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>进入接口</p>\n</li>\n<li><p>开启IPv6功能</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipv6 enable</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置IPv6地址</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipv6 address [IPv6地址] [网络号长度]   # 一个接口可以配置多个不同网段的IPv6地址</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>尝试ping 对端：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ping ipv6 [IPv6地址]</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"5-link-local地址：\"><a href=\"#5-link-local地址：\" class=\"headerlink\" title=\"5.link-local地址：\"></a>5.link-local地址：</h3><ul>\n<li><p>Link-local地址使用eui-64产生主机位</p>\n<ol>\n<li>将接口MAC地址中间拆开</li>\n<li>将FF-FE插入</li>\n<li>将第七bit反转</li>\n</ol>\n</li>\n<li><p>所有的link-local地址都以FE80开头</p>\n</li>\n<li><p>注意：在非以太网接口不存在MAC地址，使用本设备上接口最小MAC地址进行EUI-64转换</p>\n</li>\n<li><p>作用：</p>\n<ul>\n<li>在同一广播内可以通讯使用，由于本地多接口可以使用相同MAC转换，故在使用link-local地址访问对端时，需要定义出接口</li>\n<li>常常作为动态路由协议生成的路由表条目中的下一跳地址</li>\n</ul>\n</li>\n<li><p>手工配置Link-local地址</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipv6 address [IPv6地址] link-local    # 地址要以fe80开头</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>尝试ping 通对方的本地链路地址：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">查看本地链路地址</span></span><br><span class=\"line\">display ipv6 interface [接口号]</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">ping</span></span><br><span class=\"line\">ping ipv6 [对方的本地链路接口] -i [对方接口号]    </span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"6-ICMPv6协议：\"><a href=\"#6-ICMPv6协议：\" class=\"headerlink\" title=\"6.ICMPv6协议：\"></a>6.ICMPv6协议：</h3><ul>\n<li><p>Type : 类型字段，类型字段范围0-255</p>\n<ul>\n<li>0-127：ICMPV6中的错误报文（error）</li>\n<li>128-255：信令报文</li>\n</ul>\n</li>\n<li><p>ICMPV6路径MTU协商，从源到目标感知整条路径上最小的MTU值</p>\n</li>\n<li><p>NDP：邻居发现协议，代替ARP功能，学习对方的MAC地址</p>\n<ul>\n<li>ICMPV6类型135的NS（邻居请求）</li>\n<li>ICMPV6类型136的NA（邻居通告）</li>\n</ul>\n</li>\n<li><p>配置：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ping ipv6 [IPv6地址]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>地址无状态化auto-config：进行行网络前缀通告（使用RA携带，周期间隔为200s，超时时间为1800s）</p>\n<ul>\n<li><p>ICMPV6类型133 RS（路由发现）</p>\n</li>\n<li><p>ICMPV6类型 134 RA（路由通告）</p>\n</li>\n<li><p>配置：</p>\n<ul>\n<li><p>IPV6路由端关闭抑制RA发送的功能：华为设备默认抑制RA发送</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">undo ipv6 nd ra halt</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>开启IPV6的无状态化地址生成：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipv6 address auto [global/link-local]    # global：生成单播地址，link-local：生成link-local地址</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display ipv6 interface [接口号]</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"7-静态路由：\"><a href=\"#7-静态路由：\" class=\"headerlink\" title=\"7.静态路由：\"></a>7.静态路由：</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipv6 route-static [IPv6地址] [下一跳IPv6地址]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"8-动态路由：\"><a href=\"#8-动态路由：\" class=\"headerlink\" title=\"8.动态路由：\"></a>8.动态路由：</h3><ul>\n<li><p>RIP路由信息协议：</p>\n<ul>\n<li><p>创建riping协议</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">riping [进程号]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>进入接口，启动rip </p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">riping [进程号] enable    # 进入接口中</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看IPv6的RIP路由</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display ipv6 routing-talbe protocol riping</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>OSPF最短路径优先协议：</p>\n<ul>\n<li><p>创建OSPF协议：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ospfv3 [进程号]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>设置RID值：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router-id [IPv4格式ID]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>进入接口，启动OSPF，通告区域：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ospfv3 [进程号] area [区域号]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看邻居表：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display ospfv3 peer </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看LSA信息：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display ospfv3 lsdb</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>LSA类型：</p>\n<table>\n<thead>\n<tr>\n<th>LSA类型</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1类LSA</td>\n<td>存放的邻居之间的拓扑信息</td>\n</tr>\n<tr>\n<td>2类LSA</td>\n<td>描述MA网络中的路由器</td>\n</tr>\n<tr>\n<td>3类LSA</td>\n<td></td>\n</tr>\n<tr>\n<td>4类LSA</td>\n<td></td>\n</tr>\n<tr>\n<td>5类LSA</td>\n<td></td>\n</tr>\n<tr>\n<td>7类LSA</td>\n<td></td>\n</tr>\n<tr>\n<td>8类LSA</td>\n<td>描述本设备的物理链路的link-local 地址信息</td>\n</tr>\n<tr>\n<td>9类LSA</td>\n<td>描述本路由器通告本链路的路由信息</td>\n</tr>\n</tbody></table>\n</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"9-BGP协议：\"><a href=\"#9-BGP协议：\" class=\"headerlink\" title=\"9.BGP协议：\"></a>9.BGP协议：</h3><ul>\n<li><p>注意：在Cisco中可以使用IPV4地址建立BGP邻居，激活就可以建立IPV6的BGP邻居；在华为中必须使用IPV6地址建立IPV6的BGP邻居</p>\n</li>\n<li><p>配置：</p>\n<ul>\n<li><p>创建BGP协议进程：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bgp [进程号]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>指定本设备RID：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router-id [IPv4格式RID]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>指定对端的更新源地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">peer [IPv6地址] as-number [AS号]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>宣告网络：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipv6-family unicast</span><br><span class=\"line\">peer [IPv6地址] enable</span><br><span class=\"line\">network [IPv6地址] [网络长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看IPv6的邻居关系表：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp ipv6 peer </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看IPv6的邻居路由表：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">display bgp ipv6 routing-table</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"4-IPV6-IPV4共存问题\"><a href=\"#4-IPV6-IPV4共存问题\" class=\"headerlink\" title=\"4.IPV6 IPV4共存问题:\"></a>4.IPV6 IPV4共存问题:</h3><ul>\n<li><p>GRE隧道</p>\n<ul>\n<li><p>先保证路由可达</p>\n</li>\n<li><p>创建进入隧道接口</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int Tunnel[接口号]  </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置隧道接口IP地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipv6 enable</span><br><span class=\"line\">ipv6 add [IPv6地址] [网络长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>定义封装标准</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tunnel-protocol gre</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>新增报头的源IP（真实的物理接口的IP地址）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source [IPv4地址]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>新增报头的目标IP地址（真实的物理接口的IP地址）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">destination [IPv4地址]</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>IPV6overIPV4 6to4隧道</p>\n<ul>\n<li><p>先保证路由可达</p>\n</li>\n<li><p>创建进入隧道接口</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int Tunnel[接口号]  </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>配置隧道接口IP地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ipv6 enable</span><br><span class=\"line\">ipv6 add [IPv6地址] [网络长度]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>定义封装标准</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tunnel-protocol ipv6-ipv4 6to4</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>新增报头的源IP（真实的物理接口的IP地址）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source [IPv4地址]</span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n<li><p>双栈：同时部署IPV4 和 IPV6网络；当主机同时存在IPV4和IPV6的地址，IPV6优先IPV4；</p>\n</li>\n</ul>\n","_path":"2023/03/19/1.网络基础/5.HICP-BGPIPv6/","_link":"https://example.com/2023/03/19/1.%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/5.HICP-BGPIPv6/","_id":"clfgd5gdk001470q4fyvhc2xl"}}