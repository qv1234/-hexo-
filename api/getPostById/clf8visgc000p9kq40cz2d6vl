{"type":"getPostById","data":{"title":"Ansible","date":"2023-03-13T12:32:23.866Z","description":"","categories":[{"name":"Linux","_id":"clf8visfd00049kq4bz35ggc4"}],"tags":[{"name":"Linux","_id":"clf8visfg00059kq4dwn56651"}],"content":"<h2 id=\"1-playbook的概念：\"><a href=\"#1-playbook的概念：\" class=\"headerlink\" title=\"1.playbook的概念：\"></a>1.playbook的概念：</h2><ul>\n<li><p>临时命令可以作为一次性对一组主机运行简单的任务。不过，若要真正发挥Ansible的力量，需要使用playbook</p>\n</li>\n<li><p>playbook：</p>\n<ul>\n<li>playbook是ansible用于配置，部署，和管理被节点的剧本</li>\n<li>playbook是一个文本文件，playbook可以轻松重复的方式对一组主机执行多项复杂的任务。</li>\n<li>playbook包含有一个或者多个按特定顺序运行的play组成的列表</li>\n<li>play是针对对清单中选定的主机运行一组有序任务</li>\n</ul>\n</li>\n<li><p>yaml 标记语言</p>\n<ul>\n<li><p>yaml 标记语言是一个可读性高的用来表达资料序列的格式</p>\n</li>\n<li><p>YAML 语言特性</p>\n<ul>\n<li>YAML的可读性好</li>\n<li>YAML和脚本语言的交互性好</li>\n<li>YAML使用实现语言的数据类型</li>\n<li>YAML有一个一致的信息模型</li>\n<li>YAML易于实现</li>\n<li>YAML可以基于流来处理</li>\n<li>YAML表达能力强，扩展性好</li>\n</ul>\n</li>\n<li><p>YAML的三种数据结构</p>\n<table>\n<thead>\n<tr>\n<th>数据结构</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>对象</td>\n<td>键值对的集合，又称为映射、哈希、字典</td>\n</tr>\n<tr>\n<td>数组</td>\n<td>一组按次序排列的值，又称为序列&#x2F;列表</td>\n</tr>\n<tr>\n<td>纯量</td>\n<td>单个的、不可再分的值</td>\n</tr>\n</tbody></table>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 对象：</span></span><br><span class=\"line\"><span class=\"attr\">key:</span></span><br><span class=\"line\">  <span class=\"attr\">key1:</span> <span class=\"string\">vaule1</span></span><br><span class=\"line\">  <span class=\"attr\">key2:</span> <span class=\"string\">vaule2</span></span><br><span class=\"line\"><span class=\"attr\">key:</span> &#123;<span class=\"attr\">key1:</span> <span class=\"string\">value1</span>,<span class=\"attr\">key2:</span> <span class=\"string\">value2</span>&#125;</span><br><span class=\"line\"><span class=\"comment\"># 数组：</span></span><br><span class=\"line\"><span class=\"attr\">key:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">value1</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">value2</span></span><br><span class=\"line\"><span class=\"string\">key:[value1,value2]</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2-playbook的使用场景：\"><a href=\"#2-playbook的使用场景：\" class=\"headerlink\" title=\"2.playbook的使用场景：\"></a>2.playbook的使用场景：</h2><ul>\n<li>执行一些简单的任务，使用ad-hoc命令可以方便的解决问题</li>\n<li>需要大量的操作的时候，执行的ad-hoc命令是不合适的，这时候最好使用playbook</li>\n</ul>\n<h2 id=\"3-playbook的属性：\"><a href=\"#3-playbook的属性：\" class=\"headerlink\" title=\"3.playbook的属性：\"></a>3.playbook的属性：</h2><table>\n<thead>\n<tr>\n<th>属性</th>\n<th>必选</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>name</td>\n<td>no</td>\n<td>剧本的说明信息</td>\n</tr>\n<tr>\n<td>hosts</td>\n<td></td>\n<td>主机组</td>\n</tr>\n<tr>\n<td>remote_user</td>\n<td>no</td>\n<td>远程用户</td>\n</tr>\n<tr>\n<td>t asks</td>\n<td></td>\n<td>任务列表</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<table>\n<thead>\n<tr>\n<th>Tasks属性</th>\n<th>必选</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>name</td>\n<td>no</td>\n<td>任务的名字，本任务的说明</td>\n</tr>\n<tr>\n<td>[模块]</td>\n<td></td>\n<td>表示本任务使用的模块</td>\n</tr>\n</tbody></table>\n<h2 id=\"4-playbook的格式：\"><a href=\"#4-playbook的格式：\" class=\"headerlink\" title=\"4.playbook的格式：\"></a>4.playbook的格式：</h2><ul>\n<li><p>YAML的格式如下：</p>\n<ul>\n<li><p>文件的第一行应该以“—”（三个连字符）开始，表明YAML文件的开始。</p>\n</li>\n<li><p>#之后的内容表示注释</p>\n</li>\n<li><p>YAML中的列表元素以“-”开头并且跟着一个空格</p>\n</li>\n</ul>\n</li>\n<li><p>修改&#x2F;etc&#x2F;.vimrc文件，使用所有用户的yaml文件缩进变为2字符</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">autocmd FileType yaml setlocal ai ts=2 sw=2 et</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>示例一：创建uid为3333，shell为不可登录，名字为user1的剧本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim user.yml</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">create</span> <span class=\"string\">user</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> <span class=\"string\">webservers</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span> </span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">create</span> <span class=\"string\">user1</span></span><br><span class=\"line\">    <span class=\"attr\">user:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">user1</span></span><br><span class=\"line\">      <span class=\"attr\">uid:</span> <span class=\"number\">3333</span></span><br><span class=\"line\">      <span class=\"attr\">shell:</span> <span class=\"string\">/sbin/nologin</span> </span><br><span class=\"line\">      <span class=\"attr\">state:</span> <span class=\"string\">present</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>示例二：创建redhat.repo的yum源，并安装redis数据库，开机自启启动服务</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">yum</span> <span class=\"string\">install</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> <span class=\"string\">webservers</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">wget</span> <span class=\"string\">centos....repo</span></span><br><span class=\"line\">      <span class=\"attr\">get_url:</span></span><br><span class=\"line\">        <span class=\"attr\">url:</span> <span class=\"string\">https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span></span><br><span class=\"line\">        <span class=\"attr\">dest:</span> <span class=\"string\">/etc/yum.repos.d/Centos-8.5.repo</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">yum</span> <span class=\"string\">repolist</span></span><br><span class=\"line\">      <span class=\"attr\">shell:</span> <span class=\"string\">yum</span> <span class=\"string\">repolist</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">install</span> <span class=\"string\">redis</span></span><br><span class=\"line\">      <span class=\"attr\">yum:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">        <span class=\"attr\">state:</span> <span class=\"string\">present</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">systemctl</span> <span class=\"string\">redis</span></span><br><span class=\"line\">      <span class=\"attr\">service:</span></span><br><span class=\"line\">      \t<span class=\"attr\">name:</span> <span class=\"string\">reids</span></span><br><span class=\"line\">      \t<span class=\"attr\">state:</span> <span class=\"string\">restarted</span></span><br><span class=\"line\">      \t<span class=\"attr\">enabled:</span> <span class=\"literal\">yes</span></span><br></pre></td></tr></table></figure>\n</li>\n<li></li>\n</ul>\n<h2 id=\"5-Playbook的运行方式：\"><a href=\"#5-Playbook的运行方式：\" class=\"headerlink\" title=\"5.Playbook的运行方式：\"></a>5.Playbook的运行方式：</h2><ul>\n<li><p>语法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible-playbook &lt;filename.yml&gt; ... [options]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>参数类型：</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>–check  or -C</td>\n<td>只检测可能会发生的改变，但不真正执行操作</td>\n</tr>\n<tr>\n<td>–list-hosts</td>\n<td>列出运行任务的主机</td>\n</tr>\n<tr>\n<td>–list-tags</td>\n<td>列出playbook文件中定义所有的tags</td>\n</tr>\n<tr>\n<td>–list-tasks</td>\n<td>列出playbook文件中定义的所以任务集</td>\n</tr>\n<tr>\n<td>–limit</td>\n<td>主机列表 只针对主机列表中的某个主机或者某个组执行</td>\n</tr>\n<tr>\n<td>-f</td>\n<td>指定并发数，默认为5个</td>\n</tr>\n<tr>\n<td>-t</td>\n<td>指定tags运行，运行某一个或者多个tags。（前提playbook中有定义tags）</td>\n</tr>\n<tr>\n<td>-v</td>\n<td>显示任务结果</td>\n</tr>\n<tr>\n<td>-vv</td>\n<td>显示任务结果和配置</td>\n</tr>\n<tr>\n<td>-vvv</td>\n<td>显示任务结果和配置，受管主机连接信息</td>\n</tr>\n<tr>\n<td>-vvvv</td>\n<td>更详细</td>\n</tr>\n</tbody></table>\n</li>\n</ul>\n<h2 id=\"6-playbook变量\"><a href=\"#6-playbook变量\" class=\"headerlink\" title=\"6.playbook变量\"></a>6.playbook变量</h2><ul>\n<li>变量名称必须是以字母开头，并且只能含有字母、数字和下划线</li>\n<li>变量优先级：（高–低）<ol>\n<li><p>全局范围：从命令行或ansible配置设置的变量</p>\n</li>\n<li><p>play范围：在play和相关结构中设置的变量</p>\n</li>\n<li><p>主机范围：由清单、事实收集或注册的任务，在主机和个别主机上设置的变量</p>\n</li>\n</ol>\n</li>\n</ul>\n<h3 id=\"1-自定义变量的定义和引入：\"><a href=\"#1-自定义变量的定义和引入：\" class=\"headerlink\" title=\"1.自定义变量的定义和引入：\"></a>1.自定义变量的定义和引入：</h3><ul>\n<li><p>命令行定义变量：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible-playbook -e &#x27;pkname1=httpd pkname2=vsftpd&#x27; app.yml </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span>  <span class=\"string\">all</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">install</span> <span class=\"string\">package</span></span><br><span class=\"line\">    <span class=\"attr\">yum:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;  pkname1 &#125;&#125;</span>&quot;</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">install</span> <span class=\"string\">package</span></span><br><span class=\"line\">    <span class=\"attr\">yum:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123; pkname2 &#125;&#125;</span>&quot;</span><span class=\"string\">=</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>playbook中定义变量 vars</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span>  <span class=\"string\">all</span></span><br><span class=\"line\">  <span class=\"attr\">vars:</span>     <span class=\"comment\"># 定义var</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">pkname1:</span> <span class=\"string\">httpd</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">pkname2:</span> <span class=\"string\">vsftpd</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">install</span> <span class=\"string\">package</span></span><br><span class=\"line\">    <span class=\"attr\">yum:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;  pkname1 &#125;&#125;</span>&quot;</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">install</span> <span class=\"string\">package</span></span><br><span class=\"line\">    <span class=\"attr\">yum:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123; pkname2 &#125;&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>playbook中导入变量文件vars_files</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">var.yml</span></span><br><span class=\"line\"><span class=\"comment\"># 修改内容：</span></span><br><span class=\"line\"><span class=\"attr\">var1:</span> <span class=\"string\">httpd</span> </span><br><span class=\"line\"><span class=\"attr\">var2:</span> <span class=\"string\">vsftpd</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- hosts:  all</span><br><span class=\"line\">  vars_files: ./user_var.yml     # 导入文件</span><br><span class=\"line\">  - name: install package</span><br><span class=\"line\">    yum:</span><br><span class=\"line\">      name: &quot;&#123;&#123;  pkname1 &#125;&#125;&quot;</span><br><span class=\"line\">  - name: install package</span><br><span class=\"line\">    yum:</span><br><span class=\"line\">      name: &quot;&#123;&#123; pkname2 &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>定义主机变量：（主机清单）group_vars&#x2F;文件名，host_vars&#x2F;文件名</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[web]</span><br><span class=\"line\">172.16.20.131  http_port=81</span><br><span class=\"line\">172.16.20.132  http_port=82</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[web:vars]                        ----主机组变量</span><br><span class=\"line\">nodename=www       </span><br><span class=\"line\">domainname=openlab.com</span><br><span class=\"line\">[server1]</span><br><span class=\"line\">demo1.example.com</span><br><span class=\"line\">demo2.example.com</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[servers:children]                -----嵌套主机组变量</span><br><span class=\"line\">Server1</span><br><span class=\"line\">Server2</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>使用数组作为变量</p>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">user.yml</span></span><br><span class=\"line\"><span class=\"attr\">USERLIST:</span></span><br><span class=\"line\">  <span class=\"attr\">lee:</span></span><br><span class=\"line\">    <span class=\"string\">age:18</span></span><br><span class=\"line\">    <span class=\"string\">obj:linux</span></span><br><span class=\"line\">  <span class=\"attr\">westos:</span></span><br><span class=\"line\">    <span class=\"string\">age:20</span></span><br><span class=\"line\">    <span class=\"string\">obj:java</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 引入方式一</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">test</span></span><br><span class=\"line\">  <span class=\"string\">hosts:test</span></span><br><span class=\"line\">  <span class=\"string\">vars_files:./user.yml</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">create</span> <span class=\"string\">user</span></span><br><span class=\"line\">      <span class=\"attr\">debug:</span></span><br><span class=\"line\">        <span class=\"attr\">msg:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123;USERLIST.lee.age&#125;&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 引入方式二        </span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">test</span></span><br><span class=\"line\">  <span class=\"string\">hosts:test</span></span><br><span class=\"line\">  <span class=\"string\">vars_files:./user.yml</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">create</span> <span class=\"string\">user</span></span><br><span class=\"line\">    <span class=\"attr\">debug:</span></span><br><span class=\"line\">    <span class=\"string\">var:USERLIST[&#x27;lee&#x27;][&#x27;age&#x27;]</span></span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"2-系统变量的注册：\"><a href=\"#2-系统变量的注册：\" class=\"headerlink\" title=\"2.系统变量的注册：\"></a>2.系统变量的注册：</h3><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- name:test</span><br><span class=\"line\">  hosts:172.25.254.100</span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">  - name:shell</span><br><span class=\"line\">    shell:</span><br><span class=\"line\">      date</span><br><span class=\"line\">    register: WESTOS           # 把date这个命令的所有输出全部注册成了WESTOS这个变量</span><br><span class=\"line\">  - debug:</span><br><span class=\"line\">      var: WESTOS.rc           # 变量引用</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-事实变量\"><a href=\"#3-事实变量\" class=\"headerlink\" title=\"3.事实变量\"></a>3.事实变量</h3><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- name: test</span><br><span class=\"line\">  hosts: 172.25.254.100</span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">  - debug:</span><br><span class=\"line\">      var: ansible_facts[&#x27;ens3&#x27;][&#x27;ipv4&#x27;][&#x27;address&#x27;]    #取地址</span><br><span class=\"line\">      var: ansible_facts[&#x27;fqdn&#x27;]                       #取主机名称</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"7-ansible-vault加密文件：\"><a href=\"#7-ansible-vault加密文件：\" class=\"headerlink\" title=\"7.ansible vault加密文件：\"></a>7.ansible vault加密文件：</h2><h3 id=\"1-ansible-vault概念：\"><a href=\"#1-ansible-vault概念：\" class=\"headerlink\" title=\"1.ansible vault概念：\"></a>1.ansible vault概念：</h3><ul>\n<li>ansible可能需要访问密码或者API秘钥等敏感数据</li>\n<li>通常，此信息可能以纯文本形式存储在清单变量或其他ansible文件中</li>\n<li>任何有权访问ansible文件的用户或存储这些ansible文件的版本控制系统都能访问如此敏感数据。这显然存在安全风险。</li>\n<li>作用： 可以加密和解密任何由ansible使用的结构化数据文件</li>\n<li>范围：Ansible vault可以加密任何由ansible使用的结构化数据文件。<ul>\n<li>清单变量</li>\n<li>playbook中含有的变量文件</li>\n<li>在执行playbook时作为参数传递的变量文件</li>\n<li>ansible角色中定义的变量</li>\n</ul>\n</li>\n<li>ansible-vault并不实施自有的加密函数，而是使用外部python工具</li>\n</ul>\n<h3 id=\"2-ansible-vault增删改查\"><a href=\"#2-ansible-vault增删改查\" class=\"headerlink\" title=\"2.ansible vault增删改查\"></a>2.ansible vault增删改查</h3><ul>\n<li><p>创建加密文件</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@quruixiang ~]# ansible-vault create secrt.yml</span><br><span class=\"line\">New Vault password: </span><br><span class=\"line\">Confirm New Vault password: </span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">编辑内容：</span></span><br><span class=\"line\">username: root</span><br><span class=\"line\">password: 123456</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>查看加密文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">方式一：</span></span><br><span class=\"line\">[root@quruixiang ~]# ansible-vault view secrt.yml </span><br><span class=\"line\">Vault password: </span><br><span class=\"line\">username: root</span><br><span class=\"line\">password: 110119</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">方式二：文件指定（必须修改文件权限为600）</span></span><br><span class=\"line\">echo 110119 &gt; user_passwd.txt</span><br><span class=\"line\">chmod 600 user_passwd.txt </span><br><span class=\"line\">ansible-vault view create_user.yml --vault-password-file=user_passwd.txt</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>编辑加密文件：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@quruixiang /]# ansible-vault edit secrt.yml </span><br><span class=\"line\">Vault password: </span><br></pre></td></tr></table></figure>\n</li>\n<li><p>重置密码：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@quruixiang /]# ansible-vault rekey secrt.yml </span><br><span class=\"line\">Vault password: </span><br><span class=\"line\">New Vault password: </span><br><span class=\"line\">Confirm New Vault password: </span><br><span class=\"line\">Rekey successful</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>加密已有文件：（加上密码）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible-vault encryt secrt.yml</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>对加密文件进行解密：(删除密码)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ansible-vault decrypt secrt.yml</span><br></pre></td></tr></table></figure></li>\n</ul>\n<h3 id=\"3-在引用和执行：\"><a href=\"#3-在引用和执行：\" class=\"headerlink\" title=\"3.在引用和执行：\"></a>3.在引用和执行：</h3><figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">create</span> <span class=\"string\">user</span></span><br><span class=\"line\">  <span class=\"attr\">remote_user:</span> <span class=\"string\">root</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span> <span class=\"string\">webservers</span></span><br><span class=\"line\">  <span class=\"attr\">vars_files:</span></span><br><span class=\"line\">  \t<span class=\"bullet\">-</span> <span class=\"string\">./secrt.yml</span>            <span class=\"comment\"># 引入加密文件</span></span><br><span class=\"line\">  <span class=\"attr\">tasks:</span> </span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">create</span> <span class=\"string\">user1</span></span><br><span class=\"line\">    <span class=\"attr\">user:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123; username1 &#125;&#125;</span>&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">password:</span> <span class=\"string\">&quot;<span class=\"template-variable\">&#123;&#123; password1 &#125;&#125;</span>&quot;</span>     <span class=\"comment\"># 传递的用户密码需要使用python进行加密，否者失败</span></span><br><span class=\"line\">      <span class=\"attr\">shell:</span> <span class=\"string\">/sbin/nologin</span> </span><br><span class=\"line\">      <span class=\"attr\">state:</span> <span class=\"string\">present</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">方式一：咨询</span></span><br><span class=\"line\">ansible-playbook /etc/ansible/playbook/user1.yml --ask-vault-pass</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">方式二：指定密码文件,</span></span><br><span class=\"line\">ansible-playbook /etc/ansible/playbook/user1.yml --ask-vault-file=passwd</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">方式三：直接在ansible配置文件中配置vault_password_file</span></span><br><span class=\"line\">vim /etc/ansible/ansible.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">vault_password_file=./secrt/passwd</span><br><span class=\"line\"></span><br><span class=\"line\">ansible-playbook /etc/ansible/playbook/user1.yml</span><br></pre></td></tr></table></figure>\n\n\n\n<h2 id=\"8-jinjia2模板：\"><a href=\"#8-jinjia2模板：\" class=\"headerlink\" title=\"8.jinjia2模板：\"></a>8.jinjia2模板：</h2>","_path":"2023/03/13/3.linux/D2.Ansible剧本/","_link":"https://example.com/2023/03/13/3.linux/D2.Ansible%E5%89%A7%E6%9C%AC/","_id":"clf8visgc000p9kq40cz2d6vl"}}